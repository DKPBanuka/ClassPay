<!-- ======================================================= -->
<!-- FILE 1: index.html (‡∂∏‡∑ô‡∂∫ ‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± HTML file ‡∂ë‡∂ö‡∂∫‡∑í)   -->
<!-- ======================================================= -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ Meta Tags -->
    <meta name="theme-color" content="#00ff88"/>
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="shortcut icon" href="logo.png">

    <title>ClassPay - Teacher Payment Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Sinhala:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- manifest.json file ‡∂ë‡∂ö ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ -->
    <link rel="manifest" href="manifest.json">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans Sinhala', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }
        .sinhala-font {
            font-family: 'Noto Sans Sinhala', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield;
        }
        
        /* Neon Effects */
        .neon-glow {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3), 0 0 40px rgba(0, 255, 136, 0.1);
        }
        .neon-text {
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8), 0 0 20px rgba(0, 255, 136, 0.6);
        }

        .neon-border {
            border: 2px solid #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4), inset 0 0 15px rgba(0, 255, 136, 0.1);
        }
        .neon-button {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            transition: all 0.3s ease;
        }
        .neon-button:hover {
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
            transform: translateY(-2px);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .neon-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }
        .neon-input:focus {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
            outline: none;
        }
        .neon-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }
        .neon-select:focus {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
            outline: none;
        }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-to-print, #receipt-to-print * { visibility: visible; color: #000 !important; }
            #receipt-to-print { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; border: none; background: #fff !important; }
            .no-print { display: none !important; }
        }
        
        /* Modal scrolling fixes */
        .modal-container {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden !important;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 640px) {
            .modal-container {
                padding: 0.5rem;
            }
            
            .modal-container h3 {
                font-size: 0.875rem;
            }
            
            .modal-container input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body class="text-white">

    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <!-- Settings Button -->
        <div class="fixed top-4 right-4 z-50 no-print">
            <button id="settingsBtn" class="neon-button text-black font-bold p-3 rounded-lg shadow-lg flex items-center justify-center" title="Settings">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>

        <!-- Install App Button -->
        <div class="fixed top-4 left-4 z-50 no-print">
            <button id="installBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg shadow-lg hidden">
                üì± Install App
            </button>
        </div>

        <header class="text-center mb-10 no-print">
            <h1 id="teacherName" class="text-3xl md:text-4xl font-bold neon-text sinhala-font">‡∂†‡∂∏‡∑í‡∂≥‡∑î ‡∂ö‡∑ê‡∑Ö‡∑î‡∂∏‡∑ä</h1>
            <p id="teacherDegree" class="text-sm text-gray-300">BET(Hon's)(UG)</p>
            <p id="teacherUniversity" class="text-sm text-gray-300">University of Sri Jayewardenepura</p>
            <h2 class="text-2xl font-bold mt-4 neon-text">Payment System</h2>
        </header>

        <main>
            <!-- Settings Modal -->
            <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 no-print">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="glass-effect neon-border rounded-xl w-full max-w-md max-h-[90vh] flex flex-col">
                        <div class="p-6 border-b border-gray-600">
                            <h3 class="text-xl font-bold neon-text">Teacher Settings</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6">
                            <form id="settingsForm" class="space-y-6">
                                <!-- Teacher Information Section -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold neon-text border-b border-gray-600 pb-2">Teacher Information</h4>
                                    <div>
                                        <label for="settingsTeacherName" class="block mb-2 text-sm font-medium text-gray-300">Teacher Name</label>
                                        <input type="text" id="settingsTeacherName" class="neon-input rounded-lg block w-full p-2.5" required>
                                    </div>
                                    <div>
                                        <label for="settingsDegree" class="block mb-2 text-sm font-medium text-gray-300">Degree/Qualification</label>
                                        <input type="text" id="settingsDegree" class="neon-input rounded-lg block w-full p-2.5" required>
                                    </div>
                                    <div>
                                        <label for="settingsUniversity" class="block mb-2 text-sm font-medium text-gray-300">University/Institution</label>
                                        <input type="text" id="settingsUniversity" class="neon-input rounded-lg block w-full p-2.5" required>
                                    </div>
                                    <div>
                                        <label for="settingsContact" class="block mb-2 text-sm font-medium text-gray-300">Contact Number</label>
                                        <input type="text" id="settingsContact" class="neon-input rounded-lg block w-full p-2.5" required>
                                    </div>
                                </div>

                                <!-- Classes Section -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold neon-text border-b border-gray-600 pb-2">Custom Classes</h4>
                                    <div>
                                        <label class="block mb-2 text-sm font-medium text-gray-300">Class Names</label>
                                        <div class="mb-3">
                                            <div class="flex gap-2">
                                                <input type="text" id="newClassName" placeholder="Enter class name" class="neon-input rounded-lg flex-1 p-2.5">
                                                <button type="button" id="addClassBtn" class="neon-button text-black px-4 py-2 rounded-lg flex items-center gap-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                    </svg>
                                                    Add
                                                </button>
                                            </div>
                                        </div>
                                        <div id="customClassesContainer" class="space-y-2 max-h-40 overflow-y-auto">
                                            <!-- Dynamic class inputs will be added here -->
                                        </div>
                                        <p class="text-xs text-gray-400 mt-2">üí° Add your custom class names here. These will appear in the payment form dropdown.</p>
                                    </div>
                                </div>

                            </form>
                        </div>
                        <div class="p-6 border-t border-gray-600">
                            <div class="flex gap-2">
                                <button type="submit" form="settingsForm" class="flex-1 neon-button text-black font-bold py-2 rounded-lg">Save Settings</button>
                                <button type="button" id="closeSettingsBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="glass-effect neon-glow rounded-xl p-6 md:p-8 mb-10 no-print">
                <h3 class="text-xl font-bold mb-6 border-b border-gray-600 pb-3 neon-text">Record New Payment</h3>
                <form id="paymentForm" class="space-y-4">
                    <input type="hidden" id="recordId">
                    <div>
                        <label for="studentName" class="block mb-2 text-sm font-medium text-gray-300">Student Name</label>
                        <input type="text" id="studentName" class="neon-input rounded-lg block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="className" class="block mb-2 text-sm font-medium text-gray-300">Class</label>
                        <select id="className" class="neon-select rounded-lg block w-full p-2.5" required>
                            <!-- Dynamic options will be loaded here -->
                        </select>
                    </div>
                     <div>
                        <label for="paymentMonth" class="block mb-2 text-sm font-medium text-gray-300">Payment Month</label>
                        <select id="paymentMonth" class="neon-select rounded-lg block w-full p-2.5">
                            <option>January</option>
                            <option>February</option>
                            <option>March</option>
                            <option>April</option>
                            <option>May</option>
                            <option>June</option>
                            <option>July</option>
                            <option>August</option>
                            <option>September</option>
                            <option>October</option>
                            <option>November</option>
                            <option>December</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="classFees" class="block mb-2 text-sm font-medium text-gray-300">Class Fees (Rs.)</label>
                            <input type="number" id="classFees" class="neon-input rounded-lg block w-full p-2.5" required min="0">
                        </div>
                        <div>
                            <label for="paymentMethod" class="block mb-2 text-sm font-medium text-gray-300">Payment Method</label>
                            <select id="paymentMethod" class="neon-select rounded-lg block w-full p-2.5">
                                <option>Cash</option>
                                <option>Card</option>
                                <option>Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="formSubmitBtn" class="w-full neon-button text-black font-bold rounded-lg text-md px-5 py-3 text-center">
                        Record Payment
                    </button>
                    <button type="button" id="cancelEditBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg text-md px-5 py-3 text-center hidden mt-2">
                        Cancel Edit
                    </button>
                </form>
            </div>

            <!-- Current Receipt Display -->
            <div id="receipt-section" class="glass-effect neon-glow rounded-xl p-6 mb-10 hidden">
                <div id="receipt-to-print" class="p-4">
                    <!-- Header Section -->
                    <div class="text-center mb-6 border-b-2 border-gray-600 pb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-2xl font-bold mt-2 text-white neon-text">PAYMENT RECEIPT</h2>
                    </div>

                    <!-- Receipt Details -->
                    <div class="space-y-4 text-gray-300">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Receipt No:</span>
                                <p id="receiptId" class="text-md font-semibold mt-1 text-white"></p>
                            </div>
                            <div>
                                <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Date:</span>
                                <p id="receiptDate" class="text-md font-semibold mt-1 text-white"></p>
                            </div>
                        </div>

                        <div>
                            <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Student Name:</span>
                            <p id="receiptStudent" class="text-md font-semibold mt-1 text-white"></p>
                        </div>
                        
                        <div>
                             <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Class:</span>
                             <p id="receiptClass" class="text-md font-semibold mt-1 text-white"></p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Month:</span>
                                <p id="receiptMonth" class="text-md font-semibold mt-1 text-white"></p>
                            </div>
                            <div>
                                <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Method:</span>
                                <p id="receiptMethod" class="text-md font-semibold mt-1 text-white"></p>
                            </div>
                        </div>

                        <!-- Amount Highlight -->
                        <div class="text-center bg-green-900/30 rounded-xl p-4 mt-6 border border-green-500/50 neon-glow">
                            <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Amount Paid</span>
                                <p id="receiptAmount" class="text-3xl font-bold text-green-400 neon-text mt-1"></p>
                        </div>

                        <!-- Footer Section -->
                        <div class="mt-8 pt-4 border-t border-gray-600">
                            <div class="flex justify-between items-end">
                                <div class="text-center mt-4">
                                    <p id="receiptTeacherName" class="sinhala-font text-2xl font-bold text-green-400 neon-text">‡∂†‡∂∏‡∑í‡∂≥‡∑î ‡∂ö‡∑ê‡∑Ö‡∑î‡∂∏‡∑ä</p>
                                    <p id="receiptTeacherDegree" class="text-xs text-gray-400">BET(Hon's)(UG)</p>
                                    <p id="receiptTeacherUniversity" class="text-xs text-gray-400">University of Sri Jayewardenepura</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400">Teacher Contact:</p>
                                    <p id="receiptTeacherContact" class="text-sm font-medium text-white">071 3760679</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Print Button -->
                <button id="printBtn" class="w-full mt-6 neon-button text-black font-bold rounded-lg text-sm px-5 py-2.5 text-center no-print">
                    Print Receipt
                </button>
            </div>


            <!-- Payment History -->
            <div class="glass-effect neon-glow rounded-xl p-6 md:p-8 no-print">
                <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-3 neon-text">Payment History</h3>
                <div id="history-container" class="space-y-3">
                    <p class="text-gray-400">No payment records found.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Service Worker Registration (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        // --- IndexedDB Setup ---
        let db;
        const dbName = "TeacherPaymentDB_v4";
        const request = indexedDB.open(dbName, 2);

        request.onerror = (e) => console.error(`Database error: ${e.target.errorCode}`);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains("payments")) {
            db.createObjectStore("payments", { keyPath: "id", autoIncrement: true });
            }
            if (!db.objectStoreNames.contains("settings")) {
                db.createObjectStore("settings", { keyPath: "id" });
            }
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            loadSettings();
            displayHistory();
        };

        // --- DOM Elements ---
        const paymentForm = document.getElementById('paymentForm');
        const recordIdInput = document.getElementById('recordId');
        const formSubmitBtn = document.getElementById('formSubmitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const addClassBtn = document.getElementById('addClassBtn');
        const customClassesContainer = document.getElementById('customClassesContainer');

        // --- Event Listeners ---
        paymentForm.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', cancelEditMode);
        settingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        settingsForm.addEventListener('submit', saveSettings);
        addClassBtn.addEventListener('click', addCustomClass);
        
        // Add class on Enter key press
        document.addEventListener('DOMContentLoaded', function() {
            const newClassNameInput = document.getElementById('newClassName');
            if (newClassNameInput) {
                newClassNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustomClass();
                    }
                });
            }
        });
        
        // Close modal when clicking outside or pressing Escape
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeSettings();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !settingsModal.classList.contains('hidden')) {
                closeSettings();
            }
        });
        
        // --- Form Functions ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const id = recordIdInput.value ? parseInt(recordIdInput.value) : null;
            const studentName = document.getElementById('studentName').value;
            const className = document.getElementById('className').value;
            const paymentMonth = document.getElementById('paymentMonth').value;
            const classFees = parseFloat(document.getElementById('classFees').value);
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!studentName || !className || !paymentMonth || isNaN(classFees)) {
                alert('Please fill all fields correctly.');
                return;
            }

            const paymentData = { studentName, className, paymentMonth, classFees, paymentMethod };

            if (id) {
                updatePayment(id, paymentData);
            } else {
                addPayment(paymentData);
            }
        }

        function addPayment(data) {
            const newPayment = { ...data, date: new Date() };
            const tx = db.transaction("payments", "readwrite");
            const store = tx.objectStore("payments");
            const request = store.add(newPayment);

            request.onsuccess = (e) => {
                resetForm();
                displayReceipt(e.target.result);
                displayHistory();
            };
        }
        
        function updatePayment(id, data) {
            const tx = db.transaction('payments', 'readwrite');
            const store = tx.objectStore('payments');
            const getReq = store.get(id);

            getReq.onsuccess = () => {
                const oldData = getReq.result;
                const updatedRecord = { ...oldData, ...data, id: id };
                const putReq = store.put(updatedRecord);
                
                putReq.onsuccess = () => {
                    cancelEditMode();
                    displayReceipt(id);
                    displayHistory();
                };
            };
        }
        
        function editPayment(id) {
            const tx = db.transaction('payments', 'readonly');
            const store = tx.objectStore('payments');
            const req = store.get(id);

            req.onsuccess = () => {
                const data = req.result;
                recordIdInput.value = data.id;
                document.getElementById('studentName').value = data.studentName;
                document.getElementById('className').value = data.className;
                document.getElementById('paymentMonth').value = data.paymentMonth;
                document.getElementById('classFees').value = data.classFees;
                document.getElementById('paymentMethod').value = data.paymentMethod;
                
                formSubmitBtn.textContent = 'Update Payment';
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({top: 0, behavior: 'smooth'});
            };
        }

        function deletePayment(id) {
            if (confirm(`Are you sure you want to delete this record?`)) {
                 const tx = db.transaction('payments', 'readwrite');
                 const store = tx.objectStore('payments');
                 store.delete(id).onsuccess = () => displayHistory();
            }
        }
        
        function resetForm() {
            paymentForm.reset();
            recordIdInput.value = '';
        }

        function cancelEditMode() {
            resetForm();
            formSubmitBtn.textContent = 'Record Payment';
            cancelEditBtn.classList.add('hidden');
        }

        // --- Display Functions ---
        function displayReceipt(id) {
            const tx = db.transaction("payments", "readonly");
            const request = tx.objectStore("payments").get(id);

            request.onsuccess = (e) => {
                const data = e.target.result;
                if(data) {
                    // Update receipt content
                    document.getElementById('receiptId').textContent = String(data.id).padStart(4, '0');
                    document.getElementById('receiptDate').textContent = new Date(data.date).toLocaleString('en-GB');
                    document.getElementById('receiptStudent').textContent = data.studentName;
                    document.getElementById('receiptClass').textContent = data.className;
                    document.getElementById('receiptMonth').textContent = data.paymentMonth;
                    document.getElementById('receiptMethod').textContent = data.paymentMethod;
                    document.getElementById('receiptAmount').textContent = `Rs. ${data.classFees.toFixed(2)}`;
                    
                    // Load teacher settings for receipt
                    const settingsTx = db.transaction("settings", "readonly");
                    const settingsRequest = settingsTx.objectStore("settings").get('teacher');
                    settingsRequest.onsuccess = (settingsEvent) => {
                        const settings = settingsEvent.target.result;
                        if (settings) {
                            document.getElementById('receiptTeacherName').textContent = settings.teacherName;
                            document.getElementById('receiptTeacherDegree').textContent = settings.degree;
                            document.getElementById('receiptTeacherUniversity').textContent = settings.university;
                            document.getElementById('receiptTeacherContact').textContent = settings.contact;
                        }
                    };
                    
                    
                    document.getElementById('receipt-section').classList.remove('hidden');
                    document.getElementById('receipt-section').scrollIntoView({ behavior: 'smooth' });
                }
            };
        }

        function displayHistory() {
            if (!db) {
                console.error("Database not initialized. Cannot display history.");
                return;
            }
            const historyContainer = document.getElementById('history-container');
            historyContainer.innerHTML = '';

            const store = db.transaction('payments').objectStore('payments');
            store.openCursor(null, 'prev').onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const item = cursor.value;
                    const date = new Date(item.date).toLocaleDateString('en-GB');
                    const historyItem = document.createElement('div');
                    historyItem.className = 'p-3 glass-effect neon-border rounded-lg flex flex-col md:flex-row justify-between md:items-center gap-3';
                    historyItem.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-bold text-white">${item.studentName}</p>
                            <p class="text-sm text-gray-400">${item.className} &bull; ${item.paymentMonth} &bull; ${date}</p>
                            <p class="font-semibold text-green-400 neon-text mt-1">Rs. ${item.classFees.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center gap-2 self-end md:self-center">
                            <button onclick="displayReceipt(${item.id})" class="p-2 hover:bg-blue-500/20 rounded" title="Print"><svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button>
                            <button onclick="editPayment(${item.id})" class="p-2 hover:bg-yellow-500/20 rounded" title="Edit"><svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                            <button onclick="deletePayment(${item.id})" class="p-2 hover:bg-red-500/20 rounded" title="Delete"><svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    `;
                    historyContainer.appendChild(historyItem);
                    cursor.continue();
                } else if (!historyContainer.hasChildNodes()) {
                     historyContainer.innerHTML = '<p class="text-gray-400">No payment records found.</p>';
                }
            };
        }

        // --- Settings Functions ---
        function openSettings() {
            loadSettingsToForm();
            settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            settingsModal.classList.add('hidden');
        }

        function loadSettings() {
            if (!db) return;
            
            const tx = db.transaction('settings', 'readonly');
            const store = tx.objectStore('settings');
            const request = store.get('teacher');

            request.onsuccess = (e) => {
                const settings = e.target.result;
                if (settings) {
                    updateUIWithSettings(settings);
                } else {
                    // First time login - show settings prompt
                    showFirstTimeLoginPrompt();
                }
            };
        }

        function showFirstTimeLoginPrompt() {
            // Create a modal for first-time setup
            const firstTimeModal = document.createElement('div');
            firstTimeModal.id = 'firstTimeModal';
            firstTimeModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 md:p-4 overflow-y-auto modal-container';
            firstTimeModal.innerHTML = `
                <div class="glass-effect neon-border rounded-xl w-full max-w-2xl mx-auto my-4 flex flex-col min-h-0">
                    <!-- Welcome Header (Always at Top) -->
                    <div class="p-4 md:p-6 border-b border-gray-600 bg-gradient-to-r from-green-900/20 to-blue-900/20">
                        <div class="text-center">
                            <!-- Welcome Icon -->
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </div>
                            
                            <!-- Welcome Title -->
                            <h1 class="text-2xl md:text-3xl font-bold neon-text mb-3">
                                Welcome to 
                                <span class="bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">
                                    ClassPay
                                </span>
                                ! üéì
                            </h1>
                            
                            <!-- Welcome Description -->
                            <p class="text-sm md:text-base text-gray-300 leading-relaxed">
                                Your professional payment management system for teachers.<br>
                                Let's set up your profile and add your classes to get started.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Scrollable Content -->
                    <div class="flex-1 p-4 md:p-6 space-y-4 md:space-y-6 overflow-y-auto">
                    
                        <!-- Step 1: Teacher Information -->
                        <div>
                            <h3 class="text-base md:text-lg font-semibold neon-text mb-3 flex items-center gap-2">
                                <span class="bg-green-500 text-black rounded-full w-5 h-5 md:w-6 md:h-6 flex items-center justify-center text-xs md:text-sm font-bold">1</span>
                                Teacher Information
                            </h3>
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Teacher Name</label>
                                    <input type="text" id="firstTimeTeacherName" class="neon-input rounded-lg w-full p-2.5 md:p-3 text-sm md:text-base" placeholder="Enter your name" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Degree/Qualification</label>
                                    <input type="text" id="firstTimeDegree" class="neon-input rounded-lg w-full p-2.5 md:p-3 text-sm md:text-base" placeholder="e.g., B.Sc. Mathematics" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">University/Institution</label>
                                    <input type="text" id="firstTimeUniversity" class="neon-input rounded-lg w-full p-2.5 md:p-3 text-sm md:text-base" placeholder="e.g., University of Colombo" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Contact Number</label>
                                    <input type="text" id="firstTimeContact" class="neon-input rounded-lg w-full p-2.5 md:p-3 text-sm md:text-base" placeholder="+94 77 123 4567" required>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Add Classes -->
                        <div>
                            <h3 class="text-base md:text-lg font-semibold neon-text mb-3 flex items-center gap-2">
                                <span class="bg-blue-500 text-white rounded-full w-5 h-5 md:w-6 md:h-6 flex items-center justify-center text-xs md:text-sm font-bold">2</span>
                                Add Your Classes
                            </h3>
                            <div class="mb-3">
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="firstTimeClassName" placeholder="Enter class name (e.g., Grade 10 Mathematics)" class="neon-input rounded-lg flex-1 p-2.5 md:p-3 text-sm md:text-base">
                                    <button type="button" id="firstTimeAddClass" class="neon-button text-black px-3 py-2.5 md:px-4 md:py-3 rounded-lg flex items-center justify-center gap-2 text-sm md:text-base">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        <span class="hidden sm:inline">Add Class</span>
                                        <span class="sm:hidden">Add</span>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-2">üí° Add your class names here. You can add more later from Settings.</p>
                            </div>
                            <div id="firstTimeClassesContainer" class="space-y-2 max-h-24 md:max-h-32 overflow-y-auto">
                                <!-- Dynamic class inputs will be added here -->
                            </div>
                        </div>

                        <!-- Step 3: Quick Tour -->
                        <div>
                            <h3 class="text-base md:text-lg font-semibold neon-text mb-3 flex items-center gap-2">
                                <span class="bg-purple-500 text-white rounded-full w-5 h-5 md:w-6 md:h-6 flex items-center justify-center text-xs md:text-sm font-bold">3</span>
                                Quick Tour
                            </h3>
                            <div class="bg-gray-800/50 rounded-lg p-3 md:p-4">
                                <div class="space-y-2 text-xs md:text-sm text-gray-300">
                                    <div class="flex items-center gap-2">
                                        <span class="text-green-400">‚úì</span>
                                        <span>Record student payments easily</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-green-400">‚úì</span>
                                        <span>Generate professional receipts</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-green-400">‚úì</span>
                                        <span>View payment history</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-green-400">‚úì</span>
                                        <span>Works offline (PWA)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="p-6 border-t border-gray-600 flex-shrink-0">
                        <button id="saveFirstTimeSettings" class="w-full neon-button text-black font-bold py-3 rounded-lg text-sm md:text-base">Complete Setup & Start Using ClassPay</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(firstTimeModal);
            
            // Prevent body scroll when modal is open
            document.body.classList.add('modal-open');
            
            // Add event listeners
            document.getElementById('saveFirstTimeSettings').addEventListener('click', saveFirstTimeSettings);
            document.getElementById('firstTimeAddClass').addEventListener('click', addFirstTimeClass);
            
            // Add class on Enter key press
            document.getElementById('firstTimeClassName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addFirstTimeClass();
                }
            });
        }

        function addFirstTimeClass() {
            const classNameInput = document.getElementById('firstTimeClassName');
            const className = classNameInput.value.trim();
            
            if (!className) {
                alert('Please enter a class name.');
                return;
            }
            
            // Check if class already exists
            const existingClasses = Array.from(document.getElementById('firstTimeClassesContainer').querySelectorAll('input[type="text"]'))
                .map(input => input.value.trim())
                .filter(value => value);
            
            if (existingClasses.includes(className)) {
                alert('This class name already exists.');
                return;
            }
            
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center p-2 glass-effect neon-border rounded-lg';
            div.innerHTML = `
                <input type="text" value="${className}" class="neon-input rounded-lg flex-1 p-2" readonly>
                <button type="button" onclick="removeFirstTimeClass(this)" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Remove
                </button>
            `;
            document.getElementById('firstTimeClassesContainer').appendChild(div);
            classNameInput.value = '';
        }

        function removeFirstTimeClass(button) {
            button.parentElement.remove();
        }

        function saveFirstTimeSettings() {
            const teacherName = document.getElementById('firstTimeTeacherName').value;
            const degree = document.getElementById('firstTimeDegree').value;
            const university = document.getElementById('firstTimeUniversity').value;
            const contact = document.getElementById('firstTimeContact').value;
            
            if (!teacherName || !degree || !university || !contact) {
                alert('Please fill all teacher information fields.');
                return;
            }
            
            // Get custom classes
            const customClasses = Array.from(document.getElementById('firstTimeClassesContainer').querySelectorAll('input[type="text"]'))
                .map(input => input.value.trim())
                .filter(value => value);
            
            // Save settings
            const settings = {
                id: 'teacher',
                teacherName,
                degree,
                university,
                contact,
                customClasses: customClasses
            };
            
            saveSettingsToDB(settings);
            updateUIWithSettings(settings);
            
            // Remove modal
            document.body.removeChild(document.getElementById('firstTimeModal'));
            
            // Restore body scroll
            document.body.classList.remove('modal-open');
            
            // Show welcome message
            showNotification('Welcome to ClassPay! Your profile has been set up successfully. You can now start recording payments!', 'success');
        }

        function loadSettingsToForm() {
            if (!db) return;
            
            const tx = db.transaction('settings', 'readonly');
            const store = tx.objectStore('settings');
            const request = store.get('teacher');

            request.onsuccess = (e) => {
                const settings = e.target.result;
                if (settings) {
                    document.getElementById('settingsTeacherName').value = settings.teacherName;
                    document.getElementById('settingsDegree').value = settings.degree;
                    document.getElementById('settingsUniversity').value = settings.university;
                    document.getElementById('settingsContact').value = settings.contact;
                    
                    // Load custom classes
                    customClassesContainer.innerHTML = '';
                    settings.customClasses.forEach((className, index) => {
                        addCustomClassInput(className, index);
                    });
                }
            };
        }

        function saveSettings(e) {
            e.preventDefault();
            
            const customClasses = [];
            const classInputs = customClassesContainer.querySelectorAll('input[type="text"]');
            classInputs.forEach(input => {
                if (input.value.trim()) {
                    customClasses.push(input.value.trim());
                }
            });

            const settings = {
                id: 'teacher',
                teacherName: document.getElementById('settingsTeacherName').value,
                degree: document.getElementById('settingsDegree').value,
                university: document.getElementById('settingsUniversity').value,
                contact: document.getElementById('settingsContact').value,
                customClasses: customClasses
            };

            saveSettingsToDB(settings);
            updateUIWithSettings(settings);
            closeSettings();
        }

        function saveSettingsToDB(settings) {
            if (!db) return;
            
            const tx = db.transaction('settings', 'readwrite');
            const store = tx.objectStore('settings');
            store.put(settings);
        }

        function updateUIWithSettings(settings) {
            document.getElementById('teacherName').textContent = settings.teacherName;
            document.getElementById('teacherDegree').textContent = settings.degree;
            document.getElementById('teacherUniversity').textContent = settings.university;
            
            // Update class dropdown
            const classSelect = document.getElementById('className');
            classSelect.innerHTML = '';
            settings.customClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });
        }

        function addCustomClass() {
            const newClassNameInput = document.getElementById('newClassName');
            const className = newClassNameInput.value.trim();
            
            if (!className) {
                alert('Please enter a class name.');
                return;
            }
            
            // Check if class already exists
            const existingClasses = Array.from(customClassesContainer.querySelectorAll('input[type="text"]'))
                .map(input => input.value.trim())
                .filter(value => value);
            
            if (existingClasses.includes(className)) {
                alert('This class name already exists.');
                return;
            }
            
            addCustomClassInput(className);
            newClassNameInput.value = '';
        }

        function addCustomClassInput(value = '') {
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center p-2 glass-effect neon-border rounded-lg';
            div.innerHTML = `
                <input type="text" value="${value}" class="neon-input rounded-lg flex-1 p-2" placeholder="Class name" readonly>
                <button type="button" onclick="removeCustomClass(this)" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded flex items-center gap-1" title="Remove class">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Remove
                </button>
            `;
            customClassesContainer.appendChild(div);
        }

        function removeCustomClass(button) {
            if (confirm('Are you sure you want to remove this class?')) {
                button.parentElement.remove();
            }
        }


        // --- Print Functionality ---
        document.getElementById('printBtn').addEventListener('click', () => window.print());

        // Set default month on page load
        (function setDefaultMonth() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const currentMonth = monthNames[new Date().getMonth()];
            document.getElementById('paymentMonth').value = currentMonth;
        })();

        // --- PWA Installation Features ---
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            installBtn.classList.remove('hidden');
        });

        // Handle install button click
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // Hide the install button
                installBtn.classList.add('hidden');
                // Clear the deferredPrompt
                deferredPrompt = null;
            }
        });

        // Listen for the appinstalled event
        window.addEventListener('appinstalled', () => {
            console.log('ClassPay was installed successfully!');
            // Hide the install button
            installBtn.classList.add('hidden');
            // Show success message
            showNotification('ClassPay installed successfully! You can now use it like a native app.', 'success');
        });

        // Check if app is already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            // App is running in standalone mode (installed)
            installBtn.classList.add('hidden');
        }

        // Handle app shortcuts
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'add-payment') {
                // Focus on the payment form
                document.getElementById('studentName').focus();
                document.getElementById('paymentForm').scrollIntoView({ behavior: 'smooth' });
            } else if (action === 'history') {
                // Scroll to history section
                document.getElementById('history-container').scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            } text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('ClassPay Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ClassPay Service Worker registration failed:', error);
                    });
            });
        }

        // Handle offline/online status
        window.addEventListener('online', () => {
            showNotification('You are back online!', 'success');
        });

        window.addEventListener('offline', () => {
            showNotification('You are offline. ClassPay works offline too!', 'info');
        });

    </script>
</body>
</html>
